# Odroid Go Ultra bootc container
# System configuration only - bootloader handled separately by U-Boot container
ARG FEDORA_MAJOR_VERSION=42

FROM quay.io/fedora/fedora-bootc:${FEDORA_MAJOR_VERSION}

# Set up passwordless sudo for wheel group
RUN echo "%wheel ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/wheel-passwordless-sudo

# Install necessary packages
RUN dnf install -y \
    uboot-tools \
    arm-image-installer \
    kernel-core \
    mesa-dri-drivers \
    mesa-vulkan-drivers \
    mesa-libEGL \
    mesa-libGL \
    mesa-libgbm \
    libdrm \
    cloud-utils-growpart \
    gdisk \
    e2fsprogs \
    dosfstools \
    plymouth \
    && dnf clean all

# Enable SSH
RUN systemctl enable sshd

# Gaming handheld specific configurations
RUN mkdir -p /etc/udev/rules.d && \
    cat > /etc/udev/rules.d/99-odroid-go-ultra-input.rules <<'EOF'
# Odroid Go Ultra gamepad input rules
SUBSYSTEM=="input", KERNEL=="event*", ATTRS{name}=="odroid-go-ultra-joypad", MODE="0666", ENV{ID_INPUT_JOYSTICK}="1"
SUBSYSTEM=="input", KERNEL=="event*", ATTRS{name}=="gpio-keys", MODE="0666", ENV{ID_INPUT_JOYSTICK}="1"
SUBSYSTEM=="input", KERNEL=="js*", MODE="0666", ENV{ID_INPUT_JOYSTICK}="1"
EOF

# Power management service
RUN cat > /etc/systemd/system/odroid-power-management.service <<'EOF'
[Unit]
Description=Odroid Go Ultra Power Management
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/usr/bin/bash -c 'echo ondemand > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor'
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

RUN systemctl enable odroid-power-management.service

# Display test service
RUN cat > /etc/systemd/system/display-test.service <<'EOF'
[Unit]
Description=Display Test on Boot
After=multi-user.target plymouth-quit.service
Before=getty@tty1.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/display-test.sh
RemainAfterExit=yes
StandardOutput=tty
StandardError=tty
TTYPath=/dev/tty1

[Install]
WantedBy=multi-user.target
EOF

# Create display test script
RUN cat > /usr/local/bin/display-test.sh <<'EOF'
#!/bin/bash
clear > /dev/tty1
echo -e "\033[1;32m" > /dev/tty1
echo "================================" > /dev/tty1
echo "  ODROID GO ULTRA BOOT SUCCESS " > /dev/tty1
echo "================================" > /dev/tty1
echo -e "\033[0m" > /dev/tty1
echo "" > /dev/tty1
echo -e "\033[1;34mSystem Information:\033[0m" > /dev/tty1
echo "-------------------" > /dev/tty1
uname -a > /dev/tty1
echo "" > /dev/tty1
echo -e "\033[1;34mNetwork Interfaces:\033[0m" > /dev/tty1
echo "-------------------" > /dev/tty1
ip -4 addr show | grep -E "inet|^[0-9]+:" | sed 's/^/  /' > /dev/tty1
echo "" > /dev/tty1
echo -e "\033[1;34mDisk Usage:\033[0m" > /dev/tty1
echo "-------------------" > /dev/tty1
df -h / | tail -n1 | awk '{print "  Root: " $3 " / " $2 " (" $5 ")"}' > /dev/tty1
echo "" > /dev/tty1
echo -e "\033[1;32mSystem Ready!\033[0m" > /dev/tty1
echo "SSH access available at above IP addresses" > /dev/tty1
EOF

RUN chmod +x /usr/local/bin/display-test.sh && \
    systemctl enable display-test.service

# Kernel modules for Amlogic S922X
RUN echo -e "meson_drm\npanfrost\nmeson_gxl\ngpio_keys\nmeson_ir" > /etc/modules-load.d/amlogic.conf

# Install Fedora's ARM device trees
RUN dnf install -y kernel-modules && dnf clean all

# Create symlink for device trees - Fedora installs them to /usr/lib/linux-<version>/dtb
RUN mkdir -p /boot/dtb && \
    ln -sf /usr/lib/linux-*/dtb/amlogic/*.dtb /boot/dtb/ || true

# Create extlinux configuration for U-Boot
# Using fdtdir instead of fdt to let U-Boot find the right DTB
RUN mkdir -p /boot/extlinux && \
    cat > /boot/extlinux/extlinux.conf <<'EOF'
default fedora
timeout 30

label fedora
    kernel /vmlinuz
    initrd /initramfs.img
    fdtdir /dtb
    append root=LABEL=root rw rootwait console=ttyAML0,115200n8 console=tty1 quiet splash
EOF

# First boot partition resize with auto-detection
RUN cat > /usr/lib/systemd/system/growfs.service <<'EOF'
[Unit]
Description=Grow root partition on first boot
Before=local-fs-pre.target
DefaultDependencies=no

[Service]
Type=oneshot
ExecStart=/usr/local/bin/growfs.sh
StandardOutput=journal

[Install]
WantedBy=sysinit.target
EOF

RUN cat > /usr/local/bin/growfs.sh <<'EOF'
#!/bin/bash
# Auto-detect root device and grow partition
ROOT_DEV=$(findmnt -n -o SOURCE /)
ROOT_DISK=$(lsblk -no pkname "$ROOT_DEV")

if [[ "$ROOT_DISK" == "mmcblk1" ]]; then
    echo "Detected eMMC storage, growing partition..."
    growpart /dev/mmcblk1 2 && resize2fs /dev/mmcblk1p2
elif [[ "$ROOT_DISK" == "mmcblk0" ]]; then
    echo "Detected SD card storage, growing partition..."
    growpart /dev/mmcblk0 2 && resize2fs /dev/mmcblk0p2
else
    echo "Unknown storage device: $ROOT_DISK"
fi
EOF

RUN chmod +x /usr/local/bin/growfs.sh && \
    systemctl enable growfs.service

# Run bootc lint
RUN bootc container lint || true
